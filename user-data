## template: jinja
#cloud-config
disable_root: false

#MOUNTS
mounts:
  - ["/dev/vdb", "none", "swap", "sw", "0", "0"]
  - ["/dev/mapper/vgdb-db", "/var/lib/mysql", "ext4", "defaults", "1", "1"]

#PACKAGES
# packages-nginx
packages:
  - python3
  - lsof
  - netcat
  - xinetd
  - zip
  - mariadb-server
  - rsync
  - php
  - php-cli

#BOOTCMD
bootcmd:
 - mkswap /dev/vdb
 - swapon /dev/vdb
 - pvcreate /dev/vdc
 - vgcreate vgdb /dev/vdc
 - lvcreate --name db -l 100%FREE vgdb
 - mkfs.ext4 -j /dev/mapper/vgdb-db

#APT
apt:
  sources:
    mariadb.list:
      source: "deb [arch=amd64] http://mirrors.accretive-networks.net/mariadb/repo/10.3/ubuntu xenial main"
      keyid: F1656F24C74CD1D8

ntp:
  enabled: true
  ntp_client: ntp

chpasswd:
  list: |
    root:$1$xyz$quBhc72d/1S/7c2IIRk7k1
  expire: False

manage_etc_hosts: True

apt_update: true

apt_upgrade: true

ssh_pwauth: True

users:
  - name: ubuntu
    ssh-authorized_keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCvIhS6cohahZN1aeld1EyzxNSdjKm7yE/P8EG0D9GEm0PUt7Z54K009dY+/9WPLzI8163CaPKS2X7XISUfyOpvGu9BrsYVrZtSnOuV9a79ztT6Xsy2w4ePSyvq/C/nuTp/1hv/WHhodoapeAevzhOmVQYU35ouwwg3e2HBB6KxIWMUX+LwyTWeZ4TVSn0OWobmsDjo3WsnapSsxUDFMPxRo70N8ntvdrSc9jhjufzkVtMo6Z6/SLWbuoLKaPByMMGxbpRQ7YK14Ymua42y/LEookYJRg0ZiW0s0DK9gpeNrJ+qvEL8MrJeg+/2QmF5gtuv6Jcyo8QTD6SVtBVBdr95 sandholm@beast4
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    shell: /bin/bash

#RUNCMD
runcmd:
  - echo '{{ ds.meta_data.role }}' > /etc/role
  - echo '{{ ds.meta_data.aenv }}' > /etc/aenv
  - update-grub
  - apt autoremove -y
  - touch /etc/cloud/cloud-init.disabled
  - mysqladmin -u root password theresa1 
  - sed -i 's/^bind-address.*/bind-address = 0.0.0.0/g' /etc/mysql/my.cnf
  - mysql -u root --password=theresa1 -e "use mysql; CREATE USER '{{ ds.meta_data.remuser }}'@'localhost' IDENTIFIED BY '{{ ds.meta_data.remuserpsw }}';"
  - mysql -u root --password=theresa1 -e "use mysql; CREATE USER '{{ ds.meta_data.remuser }}'@'%' IDENTIFIED BY '{{ ds.meta_data.remuserpsw }}';"
  - mysql -u root --password=theresa1 -e "use mysql; GRANT ALL ON *.* TO '{{ ds.meta_data.remuser }}'@'localhost';"
  - mysql -u root --password=theresa1 -e "use mysql; GRANT ALL ON *.* TO '{{ ds.meta_data.remuser }}'@'%';"
  - systemctl 
  - eject
  - shutdown -h now
